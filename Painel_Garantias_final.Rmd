---
title: "PAINEL DE GARANTIAS"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
  
---

```{r setup, include=FALSE}

library(ggplot2)
library(shiny)
library(plotly)
library(flexdashboard)
library(knitr)
library(png)
library(readxl)
library(tidyr)
library(lubridate)
library(stringr)
library(dplyr)
#library(shinydashboard)
#library(matrixStats)
#library(rlang)
library(rmarkdown)
library(kableExtra)
#library(hpackedbubble)

load("Garantias.Rdata", envir=.GlobalEnv)

funcao_formata_quantidade <- function(x){
  paste0(format(round(x/1000000, 2), big.mark = ".", decimal.mark = ","))
}

formata <- function(x){
    paste0("R$", format(round(x, 2), big.mark = ".", decimal.mark = ","), " mi")
  }


numero <- function(x){

   a <- as.character(x)
   b <- str_replace_all(a,"\\.","")
   c <- str_replace_all(b,",","\\.")
   d <- as.numeric(c)
   
   return(d)
}


```


```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
```


Estados
=======================================================================

Column
-----------------------------------------------------------------------


### Os estados estão coloridos no mapa de acordo com o valor da dívida garantida pela União. Clique em um Estado no mapa para obter mais informações


![](Imagens/Mapa.png)

Column
-----------------------------------------------------------------------

### Detalhamento - Composição das Garantias (R$ Milhões) - Data Referência: xx/xx/xx

```{r grafico, warning=FALSE, message=FALSE  }

grupos <- c("Todas","Estados", "Bancos Federais", "Municípios","Estatais Federais","Entidades Estaduais Controladas","Empresas Privatizadas")

agrupador_total_formatado <- agrupador_total %>%
                 filter(!(Inicio %in% grupos)) %>%
                mutate(total_total = as.character(total_total), 
                       total_total = str_replace_all(total_total,"\\.",""),
                       total_total = str_replace_all(total_total,",","\\."),
                       total_total = as.numeric(total_total),
                       interna_total = numero(interna_total),
                       interna_USD = numero(interna_USD),
                       externa_total = numero(externa_total)
                )
```


```{r Botoes, warning=FALSE, message=FALSE  }


agrupador_formatado_estados <- agrupador_total_formatado %>%
               filter((Classificador == "Estados"))                            


 column(4,
                  selectInput("Mutuario", label = "Escolha o Estado:",
                 choices = agrupador_formatado_estados$Inicio)
           )



  botoes <- reactive({
  
        list(input$Mutuario)
  
      })
  
  observeEvent(botoes(),{
  
    if (is.null(input$Mutuario)){entrada <- agrupador_formatado_estados$Inicio[1]} 
    else
    {entrada <- input$Mutuario}
  
   
    if(entrada != "all"){
  
          filtro_estados <- agrupador_formatado_estados %>%
  
            filter(Inicio == entrada) }

 })
 
```


```{r completo, warning=FALSE, message=FALSE ,fig.width=9, fig.height=7 }

br()
br()
br()

fluidPage(
 fluidRow(
   br(), 
  column(width=4,align="left",div(style = "height:17px;background-color: ;","OPERAÇÕES GARANTIDAS")),
  
  
  column(width=2,align="right",div(style = "height:17px;background-color: ;",textOutput("Garantia_Total_2"))),
  
  column(width=3,align="center",div(style = "height:40px;background-color: ;","CAPAG")),
  column(width=3,align="center",div(style = "height:40px;background-color: ;",textOutput("Capag"))),
      br(), br(),
  
  column(width=2,align="center",div(style = "height:17px;background-color: ;","INTERNA")),
  
  column(width=4,align="right",div(style = "height:17px;background-color: ;",textOutput("Garantia_interna_2"))),
  
      br(),
  column(width=3,align="right",div(style = "height:17px;background-color: ;","Internas Cambiais")),
  
  column(width=3,align="right",div(style = "height:17px;background-color: ;",textOutput("Garantia_interna_cambial_2"))),
  
     
   br(),
  column(width=3,align="right",div(style = "height:17px;background-color: ;"," Internas Demais...")),
  
  column(width=3,align="right",div(style = "height:17px;background-color: ;",textOutput("Garantia_interna_demais_2"))),
  
      br(),br(),
  
  column(width=2,align="center",div(style = "height:17px;background-color: ;","EXTERNAS")),
  
  column(width=4,align="right",div(style = "height:17px;background-color: ;",textOutput("Garantia_externa_2"))),
  
      br(), br(),
  column(width=4,align="center",div(style = "height:17px;background-color: #f5f5f5;","ATM")),
  column(width=2,align="right",div(style = "height:17px;background-color: #f5f5f5;",textOutput("Garantia_ATM"))),
      br(),br(),
  column(width=4,align="center",div(style = "height:17px;background-color: #80cdc1;","Custo Médio")),
  column(width=2,align="right",div(style = "height:17px;background-color: #80cdc1;",textOutput("Garantia_custo"))),
      br(),br(),
  column(width=6,align="center",div(style = "height:17px;background-color: #01cbad;","Percentual Vincendo")),
  column(width=3,align="center",div(style = "height:17px;background-color: #01cbad;","R$ Milhões")),
      
  column(width=3,align="center",div(style = "height:17px;background-color: #01cbad;","Percentual")),
  br(),
  
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","Até 12 meses")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_12_meses"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_12_meses_percentual"))),
         
  br(),
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","De 1 a 2 anos")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_1_ano"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_1_ano_percentual"))),
  br(),
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","De 2 a 3 anos")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_2_ano"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_2_ano_percentual"))),
  
  br(),
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","De 3 a 4 anos")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_3_ano"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_3_ano_percentual"))),
  
  br(),
  
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","De 4 a 5 anos")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_4_ano"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_4_ano_percentual"))),
  
  br(),
  column(width=6,align="center",div(style = "height:17px;background-color: #e6fffb;","Mais de 5 anos")),
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_5_ano"))),
         
  column(width=3,align="center",div(style = "height:17px;background-color: #e6fffb;",textOutput("Garantia_5_ano_percentual"))),
  
      br(),br(),
  
  column(width=4,align="center",div(style = "height:17px;background-color: ;","CONTRATOS ASSINADOS"))
  
  
  
 ))

Garantia_Total_reativo <- reactive({

       list(input$Mutuario)

     })

Garantia_ATM_reativo <- reactive({

       list(input$Mutuario)

     })

Garantia_Custo_reativo <- reactive({

       list(input$Mutuario)

     })

Garantia_Vincendo_reativo <- reactive({

       list(input$Mutuario)

     })

Garantia_Capag_reativo <- reactive({

       list(input$Mutuario)

     })


 observeEvent(Garantia_Total_reativo(),{

   if (is.null(input$Mutuario)){entrada <- "agrupador_total$Classificador[1]"} 
   else
   {entrada <- input$Mutuario}
 
   
   if(entrada != "all"){

         filtro_classificador_estado <- agrupador_formatado_estados %>%

           filter(Inicio == entrada) }
   

   
   output$Garantia_Total_2 <- renderText(paste0(funcao_formata_quantidade(filtro_classificador_estado$total_total)))
   
  output$Garantia_interna_2 <- renderText(paste0(funcao_formata_quantidade(filtro_classificador_estado$interna_total)))
    
  output$Garantia_interna_cambial_2 <- renderText(paste0(funcao_formata_quantidade(filtro_classificador_estado$interna_USD)))
  
  output$Garantia_interna_demais_2 <- renderText(paste0(funcao_formata_quantidade(filtro_classificador_estado$interna_total-filtro_classificador_estado$interna_USD)))
  
output$Garantia_externa_2 <- renderText(paste0(funcao_formata_quantidade(filtro_classificador_estado$externa_total)))

})

#ATM 

observeEvent(Garantia_ATM_reativo(),{

   if (is.null(input$Mutuario)){entrada <- "agrupador_atm_completo$Classificador[1]"} 
   else
   {entrada <- input$Mutuario}
 
   
   if(entrada != "all"){

         filtro_classificador_estado_atm <- agrupador_atm_completo %>%
               filter(Classificador == "Estados") %>%

                      filter(Inicio == entrada) }

  output$Garantia_ATM <- renderText(paste0(round(numero(filtro_classificador_estado_atm$ATM_Total),2), " anos"))
  
})
  
  #CUSTO
  
  observeEvent(Garantia_Custo_reativo(),{

   if (is.null(input$Mutuario)){entrada <- "agrupador_custo_completo$Classificador[1]"} 
   else
   {entrada <- input$Mutuario}
 
   
   if(entrada != "all"){

         filtro_classificador_estado_custo <- agrupador_custo_completo %>%
               filter(Classificador == "Estados") %>%

                      filter(Inicio == entrada) }

  output$Garantia_custo <- renderText(paste0(filtro_classificador_estado_custo$Custo_Total, " a.a"))
  

 })
  
  #PERCENTUAL VINCENDO
  
  observeEvent(Garantia_Vincendo_reativo(),{

   if (is.null(input$Mutuario)){entrada <- "agrupador_custo_completo$Classificador[1]"} 
   else
   {entrada <- input$Mutuario}
 
   
   if(entrada != "all"){

         filtro_classificador_estado_vincendo <- agrupador_percentual_vincendo %>%
               filter(Classificador == "Estados") %>%

                      filter(Inicio == entrada) }

  output$Garantia_12_meses <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$Ate_12_meses))))
  
  output$Garantia_12_meses_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$Ate_12_meses_percentual))
  
  output$Garantia_1_ano <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$De_1_2_anos))))

  output$Garantia_1_ano_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$De_1_2_anos_percentual))
  
  output$Garantia_2_ano <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$De_2_3_anos))))
  
  output$Garantia_2_ano_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$De_2_3_anos_percentual))
  
  output$Garantia_3_ano <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$De_3_4_anos))))
  
  output$Garantia_3_ano_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$De_3_4_anos_percentual))
  
  output$Garantia_4_ano <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$De_4_5_anos))))
  
  output$Garantia_4_ano_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$De_4_5_anos_percentual))
  
  output$Garantia_5_ano <- renderText(paste0(funcao_formata_quantidade(numero(filtro_classificador_estado_vincendo$Acima_5_anos))))
  
  output$Garantia_5_ano_percentual <- renderText(paste0(filtro_classificador_estado_vincendo$Acima_5_anos_percentual))

 })
  
#CAPAG
  
observeEvent(Garantia_Capag_reativo(),{

   if (is.null(input$Mutuario)){entrada <- "agrupador_custo_completo$Classificador[1]"} 
   else
   {entrada <- input$Mutuario}
 
   
   if(entrada != "all"){

         filtro_classificador_estado_capag <- novos_contratos %>%
               filter(`Tipo Mutuário` == "Estados") %>%

                      filter(`Mutuário` == entrada) }
  
 output$Capag <- renderText(paste0(filtro_classificador_estado_capag$CAPAG[1]))

})
  
  
 

```






Municípios
=======================================================================

Column
-----------------------------------------------------------------------


### SALDO GARANTIAS - Quadrmiestre xx


![](Imagens/Municipios.png)

Column
-----------------------------------------------------------------------

### Detalhamento - Composição das Garantias

![](Imagens/opcao_municipio.png)
![](Imagens/Card_RJ.png)



Estatais Federais
=======================================================================
Column
-----------------------------------------------------------------------


### SALDO GARANTIAS - Quadrmiestre xx


![](Imagens/estatais.png)

Column
-----------------------------------------------------------------------

### Detalhamento - Composição das Garantias

![](Imagens/opcao_estatal.png)
![](Imagens/Card_estatal.png)

Bancos Federais
=======================================================================
Column
-----------------------------------------------------------------------


### SALDO GARANTIAS - Quadrmiestre xx


![](Imagens/Bancos_Federais.png)

Column
-----------------------------------------------------------------------

### Detalhamento - Composição das Garantias

![](Imagens/opcao_municipio.png)
![](Imagens/Card_RJ.png)

Entidades Controladas
=======================================================================
Column
-----------------------------------------------------------------------


### SALDO GARANTIAS - Quadrmiestre xx


![](Imagens/entidades.png)

Column
-----------------------------------------------------------------------

### Detalhamento - Composição das Garantias

![](Imagens/opcao_municipio.png)
![](Imagens/Card_RJ.png)

Quadro Geral
=======================================================================

Column
-------------------------------------------------------------------------

### SALDO GARANTIAS A OPERAÇÕES DE CRÉDITO (quadrimestre xx)

![](Imagens/correto.png)


Column
-------------------------------------------------------------------------

### MUTUÁRIOS - COMPOSIÇÃO DAS GARANTIAS (quadrimestre xx)

![](Imagens/mutuario_geral.png)


Column
-----------------------------------------------------------------------


### Credores - COMPOSIÇÃO DAS GARANTIAS (quadrimestre xx)

![](Imagens/credor_total.png)


